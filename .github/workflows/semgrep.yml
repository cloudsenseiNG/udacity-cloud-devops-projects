name: Semgrep
on: 
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
    - main
    - master
    paths:
    - .github/workflows/semgrep.yml
  schedule:
    - cron: 55 14 * * *

jobs:
  semgrep_include:
    strategy:
      matrix:
        subdir:
          - cloud-devops-ci-cd-udapeople
          - cloud-devops-cloudformation
          - cloud-devops-operationalizing-ml
          - cloud-devops-static-website  
    name: semgrep/ci
    runs-on: ubuntu-20.04
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      SEMGREP_REPO_DISPLAY_NAME: monorepo-test--${{ matrix.subdir }}
    container:
      image: returntocorp/semgrep
    steps:
    - uses: actions/checkout@v3
    - run: semgrep ci --json --output report.json --include=${{ matrix.subdir }} || true
    - name: Upload report as artifact
      uses: actions/upload-artifact@v3
      with:
        name: semgrep-report-${{ matrix.subdir }}
        path: report.json

  combine_reports:
    needs: semgrep_include
    runs-on: ubuntu-20.04
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v3
      with:
        name: semgrep-report-*
        path: ./reports

    - name: Combine reports
      run: |
        jq -s 'reduce .[] as $item ({}; . + $item)' ./reports/**/*.json > combined_report.json
    - name: Upload combined report
      uses: actions/upload-artifact@v3
      with:
        name: combined-semgrep-report
        path: combined_report.json

  # semgrep_exclude: 
  #   name: semgrep/ci
  #   runs-on: ubuntu-20.04
  #   env:
  #     SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  #   container:
  #     image: returntocorp/semgrep
  #   steps:
  #   - uses: actions/checkout@v3
  #   - run: semgrep ci

